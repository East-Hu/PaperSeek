name: Daily Papers Workflow

on:
  # schedule:
  #   # æ¯å¤© UTC æ—¶é—´ 9:00 è¿è¡Œ (åŒ—äº¬æ—¶é—´ 17:00) - DISABLED
  #   - cron: '0 9 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      keywords:
        description: 'æœç´¢å…³é”®è¯'
        required: true
        default: 'AI Security'
      max_results:
        description: 'æœ€å¤§ç»“æžœæ•°'
        required: false
        default: '20'
      enable_ai_summary:
        description: 'ç”ŸæˆAIæ‘˜è¦'
        required: false
        type: boolean
        default: true
      enable_tagging:
        description: 'è‡ªåŠ¨æ·»åŠ æ ‡ç­¾'
        required: false
        type: boolean
        default: true
      download_pdf:
        description: 'ä¸‹è½½PDFæ–‡ä»¶'
        required: false
        type: boolean
        default: false

jobs:
  fetch-papers:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push commits
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          # Verify installation
          which paper-seek-max || echo "paper-seek-max not in PATH"
          python -c "import paper_to_action; print('Package imported successfully')"
      
      - name: Configure API
        env:
          API_KEY: ${{ secrets.API_KEY }}
          BASE_URL: ${{ secrets.BASE_URL }}
        run: |
          mkdir -p ~/.paper_robot
          cat > ~/.paper_robot/config.yaml << EOF
          robot_name: "GitHub Actions Paper Robot"
          api_key: "$API_KEY"
          base_url: "$BASE_URL"
          model: "gpt-4o-mini"
          max_results: ${{ github.event.inputs.max_results || '20' }}
          language: "zh"
          output_dir: "papers"
          EOF
      
      - name: Search papers
        env:
          KEYWORDS: ${{ github.event.inputs.keywords || 'AI Security' }}
          MAX_RESULTS: ${{ github.event.inputs.max_results || '20' }}
          ENABLE_AI_SUMMARY: ${{ github.event.inputs.enable_ai_summary || 'true' }}
          ENABLE_TAGGING: ${{ github.event.inputs.enable_tagging || 'true' }}
          DOWNLOAD_PDF: ${{ github.event.inputs.download_pdf || 'false' }}
        run: |
          # Use non-interactive script for GitHub Actions
          python scripts/github_search.py "$KEYWORDS" "$MAX_RESULTS" "$ENABLE_AI_SUMMARY" "$ENABLE_TAGGING" "$DOWNLOAD_PDF"
      
      - name: Commit and push results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Paper Robot"
          
          DATE=$(date +'%Y-%m-%d')
          git add -f papers/  # Force add despite .gitignore
          
          if git diff --staged --quiet; then
            echo "No new papers found"
          else
            git commit -m "ðŸ“š Daily paper update - $DATE"
            git push
          fi
